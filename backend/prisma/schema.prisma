generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==================== CORE USER SYSTEM ====================

// Root System (Super Admin Layer) - Receives commissions from Admin ecosystem
model Root {
  id                   String     @id @default(uuid())
  username             String     @unique
  firstName            String     @map("first_name")
  lastName             String     @map("last_name")
  profileImage         String?    @map("profile_image") @db.Text
  email                String     @unique
  phoneNumber          String     @unique @map("phone_number")
  password             String
  status               UserStatus @default(ACTIVE)
  refreshToken         String?    @map("refresh_token") @db.Text
  passwordResetToken   String?    @map("password_reset_token")
  passwordResetExpires DateTime?  @map("password_reset_expires")
  lastLoginAt          DateTime?  @map("last_login_at")
  createdAt            DateTime   @default(now()) @map("created_at")
  updatedAt            DateTime   @default(now()) @updatedAt @map("updated_at")

  // Root Business Capabilities (Commission focused)
  wallets            RootWallet[]
  bankAccounts       RootBankDetail[]
  commissionEarnings RootCommissionEarning[]

  // Management Capabilities
  employees                 Employee[]
  departments               Department[]
  systemSettings            SystemSetting[]
  createdRoles              Role[]              @relation("RoleCreatedByRoot")
  commissionSettingsCreated CommissionSetting[] @relation("CommissionSettingCreatedByRoot")
  ipWhitelists              IpWhitelist[]

  // KYC Verification Relations
  verifiedUserKycs     UserKyc[]     @relation("UserKycVerifiedByRoot") // Can verify any User KYC
  verifiedBusinessKycs BusinessKyc[] @relation("BusinessKycVerifiedBy") // Can verify Business KYC

  // Business KYC records owned by this Root
  ownedBusinessKycs BusinessKyc[] @relation("BusinessKycOwnedBy")

  // Service Management - Only Root can create services
  serviceProviders ServiceProvider[]

  // Permissions created by Root
  createdRolePermissions       RolePermission[]       @relation("RolePermissionCreatedByRoot")
  createdUserPermissions       UserPermission[]       @relation("UserPermissionCreatedByRoot")
  createdDepartmentPermissions DepartmentPermission[] @relation("DepartmentPermissionCreatedByRoot")
  createdEmployeePermissions   EmployeePermission[]   @relation("EmployeePermissionCreatedByRoot")

  @@map("roots")
}

// Employee System - Can be created by both Root AND Admin
model Employee {
  id                   String     @id @default(uuid())
  username             String     @unique
  firstName            String     @map("first_name")
  lastName             String     @map("last_name")
  profileImage         String?    @map("profile_image") @db.Text
  email                String     @unique
  phoneNumber          String     @unique @map("phone_number")
  password             String
  departmentId         String     @map("department_id")
  status               UserStatus @default(ACTIVE)
  refreshToken         String?    @map("refresh_token") @db.Text
  passwordResetToken   String?    @map("password_reset_token")
  passwordResetExpires DateTime?  @map("password_reset_expires")
  lastLoginAt          DateTime?  @map("last_login_at")
  createdAt            DateTime   @default(now()) @map("created_at")
  updatedAt            DateTime   @default(now()) @updatedAt @map("updated_at")
  deactivationReason   String?    @map("deactivation_reason") @db.LongText

  // Employee can be created by Root OR Admin
  createdByType CreatorType @map("created_by_type")
  createdById   String      @map("created_by_id")

  // Relations
  department          Department           @relation(fields: [departmentId], references: [id])
  employeePermissions EmployeePermission[]
  rootId              String?
  root                Root?                @relation(fields: [rootId], references: [id])
  userId              String?
  user                User?                @relation(fields: [userId], references: [id])
  createdByUser       User?                @relation("EmployeeCreatedByUser", fields: [createdById], references: [id])

  @@index([departmentId])
  @@index([createdById, createdByType])
  @@map("employees")
}

// ==================== BUSINESS USER HIERARCHY ====================

// Main Business User Table with Hierarchical Structure
model User {
  id                            String             @id @default(uuid())
  username                      String             @unique
  firstName                     String             @map("first_name")
  lastName                      String             @map("last_name")
  profileImage                  String?            @map("profile_image") @db.Text
  email                         String             @unique
  phoneNumber                   String             @unique @map("phone_number")
  password                      String
  transactionPin                String?            @map("transaction_pin") @db.Text
  parentId                      String?            @map("parent_id")
  hierarchyLevel                UserHierarchyLevel @map("hierarchy_level")
  hierarchyPath                 String             @map("hierarchy_path")
  status                        UserStatus         @default(ACTIVE)
  isKycVerified                 Boolean            @default(false) @map("is_kyc_verified")
  roleId                        String             @map("role_id")
  refreshToken                  String?            @map("refresh_token") @db.Text
  passwordResetToken            String?            @map("password_reset_token")
  passwordResetExpires          DateTime?          @map("password_reset_expires")
  emailVerificationToken        String?            @map("email_verification_token")
  emailVerifiedAt               DateTime?          @map("email_verified_at")
  emailVerificationTokenExpires DateTime?          @map("email_verification_token_expires")
  createdAt                     DateTime           @default(now()) @map("created_at")
  updatedAt                     DateTime           @default(now()) @updatedAt @map("updated_at")
  deletedAt                     DateTime?          @map("deleted_at")
  deactivationReason            String?            @map("deactivation_reason") @db.LongText

  // Relations - Business specific
  parent       User?        @relation("UserHierarchy", fields: [parentId], references: [id])
  children     User[]       @relation("UserHierarchy")
  role         Role         @relation(fields: [roleId], references: [id])
  wallets      Wallet[]
  bankAccounts BankDetail[]

  // KYC Relations - Now one-to-one with @unique
  userKyc     UserKyc? // Individual KYC
  businessKyc BusinessKyc? // Business KYC (Only for Admin)

  // KYC Verification Relations (For users under Admin)
  verifiedUserKycs UserKyc[] @relation("UserKycVerifiedByUser")

  transactions              Transaction[]
  commissionEarnings        CommissionEarning[]     @relation("CommissionEarningToUser")
  commissionsGiven          CommissionEarning[]     @relation("CommissionEarningFromUser")
  rootCommissionsGiven      RootCommissionEarning[] @relation("RootCommissionFromUser")
  userPermissions           UserPermission[]
  piiConsents               PiiConsent[]
  apiEntities               ApiEntity[]
  ipWhitelists              IpWhitelist[]
  employeesCreated          Employee[]              @relation("EmployeeCreatedByUser")
  commissionSettingsCreated CommissionSetting[]     @relation("CommissionSettingCreatedByUser")
  rolesCreated              Role[]                  @relation("RoleCreatedByUser")
  commissionSettings        CommissionSetting[]
  departments               Department[]
  employees                 Employee[]

  // Permissions created by Admin User
  createdRolePermissions       RolePermission[]       @relation("RolePermissionCreatedByUser")
  createdUserPermissions       UserPermission[]       @relation("UserPermissionCreatedByUser")
  createdDepartmentPermissions DepartmentPermission[] @relation("DepartmentPermissionCreatedByUser")
  createdEmployeePermissions   EmployeePermission[]   @relation("EmployeePermissionCreatedByUser")

  @@index([parentId])
  @@index([hierarchyLevel])
  @@index([hierarchyPath])
  @@index([phoneNumber])
  @@index([roleId])
  @@map("users")
}

// ==================== ROOT BUSINESS ECOSYSTEM ====================

// Root Wallet System (Only for receiving commissions from Admin ecosystem)
model RootWallet {
  id               String     @id @default(uuid())
  rootId           String     @map("root_id")
  balance          BigInt     @default(0)
  currency         Currency   @default(INR)
  walletType       WalletType @default(PRIMARY) @map("wallet_type")
  holdBalance      BigInt     @default(0) @map("hold_balance")
  availableBalance BigInt     @default(0) @map("available_balance")
  isActive         Boolean    @default(true) @map("is_active")
  version          Int        @default(1)
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")

  // Relations
  root               Root                    @relation(fields: [rootId], references: [id])
  commissionEarnings RootCommissionEarning[]
  ledgerEntries      RootLedgerEntry[]

  @@unique([rootId, walletType])
  @@map("root_wallets")
}

// Root Commission Earnings (ONLY from Admin users transactions)
model RootCommissionEarning {
  id                String         @id @default(uuid())
  // Source transaction from Admin ecosystem
  userTransactionId String         @map("user_transaction_id")
  rootId            String         @map("root_id")
  walletId          String         @map("wallet_id")
  fromUserId        String         @map("from_user_id") // Admin user who generated this commission
  amount            BigInt
  commissionAmount  BigInt         @map("commission_amount")
  commissionType    CommissionType @map("commission_type")
  tdsAmount         BigInt?        @map("tds_amount")
  gstAmount         BigInt?        @map("gst_amount")
  netAmount         BigInt         @map("net_amount")
  metadata          Json?
  createdAt         DateTime       @default(now()) @map("created_at")

  // Relations
  root              Root              @relation(fields: [rootId], references: [id])
  wallet            RootWallet        @relation(fields: [walletId], references: [id])
  fromUser          User              @relation("RootCommissionFromUser", fields: [fromUserId], references: [id])
  userTransaction   Transaction       @relation(fields: [userTransactionId], references: [id])
  rootLedgerEntries RootLedgerEntry[]

  @@index([userTransactionId])
  @@index([fromUserId, createdAt])
  @@index([rootId, createdAt])
  @@map("root_commission_earnings")
}

// Root Bank Details
model RootBankDetail {
  id                  String      @id @default(uuid())
  accountHolder       String      @map("account_holder") @db.Text
  accountNumber       String      @unique @map("account_number") @db.VarChar(18)
  phoneNumber         String      @map("phone_number")
  accountType         AccountType @map("account_type")
  ifscCode            String      @map("ifsc_code") @db.Text
  bankName            String      @map("bank_name") @db.Text
  bankRejectionReason String?     @map("bank_rejection_reason") @db.LongText
  bankProofFile       String      @map("bank_proof_file")
  status              KycStatus   @default(PENDING)
  isPrimary           Boolean     @default(false) @map("is_primary")
  rootId              String      @map("root_id")
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @default(now()) @updatedAt @map("updated_at")

  root Root @relation(fields: [rootId], references: [id])

  @@index([rootId])
  @@map("root_bank_details")
}

// Root Ledger Entries
model RootLedgerEntry {
  id                  String          @id @default(uuid())
  commissionEarningId String?         @map("commission_earning_id")
  walletId            String          @map("wallet_id")
  entryType           LedgerEntryType @map("entry_type")
  referenceType       ReferenceType   @map("reference_type")
  amount              BigInt
  runningBalance      BigInt          @map("running_balance")
  narration           String          @db.Text
  metadata            Json?
  createdAt           DateTime        @default(now()) @map("created_at")

  wallet            RootWallet             @relation(fields: [walletId], references: [id])
  commissionEarning RootCommissionEarning? @relation(fields: [commissionEarningId], references: [id])

  @@index([walletId, createdAt])
  @@map("root_ledger_entries")
}

// ==================== ADMIN BUSINESS ECOSYSTEM ====================

// User Wallet System
model Wallet {
  id                  String     @id @default(uuid())
  userId              String     @map("user_id")
  balance             BigInt     @default(0)
  currency            Currency   @default(INR)
  walletType          WalletType @default(PRIMARY) @map("wallet_type")
  holdBalance         BigInt     @default(0) @map("hold_balance")
  availableBalance    BigInt     @default(0) @map("available_balance")
  dailyLimit          BigInt?    @map("daily_limit")
  monthlyLimit        BigInt?    @map("monthly_limit")
  perTransactionLimit BigInt?    @map("per_transaction_limit")
  isActive            Boolean    @default(true) @map("is_active")
  version             Int        @default(1)
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")
  deletedAt           DateTime?  @map("deleted_at")

  // Relations
  user          User          @relation(fields: [userId], references: [id])
  ledgerEntries LedgerEntry[]
  transactions  Transaction[]

  @@unique([userId, walletType])
  @@index([userId, isActive])
  @@map("wallets")
}

// User Transactions
model Transaction {
  id             String      @id @default(uuid())
  referenceId    String?     @map("reference_id")
  externalRefId  String?     @map("external_ref_id")
  idempotencyKey String?     @map("idempotency_key")
  amount         BigInt
  currency       Currency    @default(INR)
  netAmount      BigInt
  status         TxStatus    @default(PENDING)
  serviceId      String?     @map("service_id")
  paymentType    PaymentType @map("payment_type")
  userId         String      @map("user_id")
  walletId       String      @map("wallet_id")
  apiEntityId    String?     @map("api_entity_id")

  // Commission tracking
  totalCommission BigInt? @default(0) @map("total_commission")
  rootCommission  BigInt? @default(0) @map("root_commission")

  providerCharge    BigInt?
  taxAmount         BigInt?   @map("tax_amount")
  feeAmount         BigInt?   @map("fee_amount")
  cashbackAmount    BigInt?   @map("cashback_amount")
  providerReference String?   @map("provider_reference")
  providerResponse  Json?     @map("provider_response")
  requestPayload    Json?
  responsePayload   Json?
  initiatedAt       DateTime  @default(now()) @map("initiated_at")
  processedAt       DateTime? @map("processed_at")
  completedAt       DateTime? @map("completed_at")

  // Relations
  user                   User                    @relation(fields: [userId], references: [id])
  wallet                 Wallet                  @relation(fields: [walletId], references: [id])
  apiEntity              ApiEntity?              @relation(fields: [apiEntityId], references: [id])
  service                ServiceProvider?        @relation(fields: [serviceId], references: [id])
  apiWebhooks            ApiWebhook[]
  commissionEarnings     CommissionEarning[]
  rootCommissionEarnings RootCommissionEarning[]
  ledgerEntries          LedgerEntry[]
  refunds                Refund[]

  @@index([userId, status])
  @@index([idempotencyKey])
  @@index([serviceId, initiatedAt])
  @@index([externalRefId])
  @@index([providerReference])
  @@index([status, initiatedAt])
  @@index([walletId])
  @@map("transactions")
}

// User Commission Earnings
model CommissionEarning {
  id               String  @id @default(uuid())
  transactionId    String  @map("transaction_id")
  userId           String  @map("user_id")
  fromUserId       String? @map("from_user_id")
  amount           BigInt
  commissionAmount BigInt  @map("commission_amount")

  // Root commission deducted from this earning
  rootCommissionAmount BigInt? @default(0) @map("root_commission_amount")

  commissionType CommissionType @map("commission_type")
  tdsAmount      BigInt?        @map("tds_amount")
  gstAmount      BigInt?        @map("gst_amount")
  netAmount      BigInt         @map("net_amount")
  metadata       Json?
  createdAt      DateTime       @default(now()) @map("created_at")

  // Relations
  transaction Transaction @relation(fields: [transactionId], references: [id])
  user        User        @relation("CommissionEarningToUser", fields: [userId], references: [id])
  fromUser    User?       @relation("CommissionEarningFromUser", fields: [fromUserId], references: [id])

  @@index([transactionId, userId])
  @@index([userId, createdAt])
  @@map("commission_earnings")
}

// User Bank Details
model BankDetail {
  id                  String      @id @default(uuid())
  accountHolder       String      @map("account_holder") @db.Text
  accountNumber       String      @unique @map("account_number") @db.VarChar(18)
  phoneNumber         String      @map("phone_number")
  accountType         AccountType @map("account_type")
  ifscCode            String      @map("ifsc_code") @db.Text
  bankName            String      @map("bank_name") @db.Text
  bankRejectionReason String?     @map("bank_rejection_reason") @db.LongText
  bankProofFile       String      @map("bank_proof_file")
  status              KycStatus   @default(PENDING)
  isPrimary           Boolean     @default(false) @map("is_primary")
  userId              String      @map("user_id")
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @default(now()) @updatedAt @map("updated_at")
  deletedAt           DateTime?   @map("deleted_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("bank_details")
}

// User Ledger Entries
model LedgerEntry {
  id             String          @id @default(uuid())
  transactionId  String?         @map("transaction_id")
  walletId       String          @map("wallet_id")
  entryType      LedgerEntryType @map("entry_type")
  referenceType  ReferenceType   @map("reference_type")
  serviceId      String?         @map("service_id")
  amount         BigInt
  runningBalance BigInt          @map("running_balance")
  narration      String          @db.Text
  metadata       Json?
  idempotencyKey String?         @map("idempotency_key")
  createdAt      DateTime        @default(now()) @map("created_at")

  service     ServiceProvider? @relation(fields: [serviceId], references: [id])
  transaction Transaction?     @relation(fields: [transactionId], references: [id])
  wallet      Wallet           @relation(fields: [walletId], references: [id])

  @@index([transactionId])
  @@index([walletId, createdAt])
  @@index([serviceId, referenceType])
  @@index([idempotencyKey])
  @@map("ledger_entries")
}

// ==================== SHARED BUSINESS MODELS ====================

// Commission Settings (Can be created by both Root AND Admin)
model CommissionSetting {
  id              String          @id @default(uuid())
  scope           CommissionScope @default(ROLE)
  roleId          String?         @map("role_id")
  targetUserId    String?         @map("target_user_id")
  serviceId       String?         @map("service_id")
  commissionType  CommissionType  @map("commission_type")
  commissionValue Decimal         @map("commission_value") @db.Decimal(12, 4)
  minAmount       BigInt?         @map("min_amount")
  maxAmount       BigInt?         @map("max_amount")

  // Root Commission (when transactions happen in Admin hierarchy, Root gets this %)
  rootCommissionPercent Decimal? @map("root_commission_percent") @db.Decimal(5, 2)

  applyTDS      Boolean   @default(false) @map("apply_tds")
  tdsPercent    Decimal?  @map("tds_percent") @db.Decimal(5, 2)
  applyGST      Boolean   @default(false) @map("apply_gst")
  gstPercent    Decimal?  @map("gst_percent") @db.Decimal(5, 2)
  isActive      Boolean   @default(true) @map("is_active")
  effectiveFrom DateTime  @default(now()) @map("effective_from")
  effectiveTo   DateTime? @map("effective_to")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")

  // Can be created by Root OR Admin User
  createdByType CreatorType @map("created_by_type")
  createdById   String      @map("created_by_id")

  // Relations
  role          Role?            @relation(fields: [roleId], references: [id])
  targetUser    User?            @relation(fields: [targetUserId], references: [id])
  service       ServiceProvider? @relation(fields: [serviceId], references: [id])
  createdByRoot Root?            @relation("CommissionSettingCreatedByRoot", fields: [createdById], references: [id], map: "commission_settings_created_by_root_fk")
  createdByUser User?            @relation("CommissionSettingCreatedByUser", fields: [createdById], references: [id], map: "commission_settings_created_by_user_fk")

  @@index([scope, roleId, targetUserId])
  @@index([isActive, effectiveFrom, effectiveTo])
  @@index([createdById, createdByType])
  @@map("commission_settings")
}

// Roles (Can be created by both Root AND Admin)
model Role {
  id             String             @id @default(uuid())
  name           String             @unique
  hierarchyLevel UserHierarchyLevel @unique @map("hierarchy_level")
  description    String?            @db.LongText
  createdByType  CreatorType        @map("created_by_type")
  createdById    String             @map("created_by_id")
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @default(now()) @updatedAt @map("updated_at")

  // Relations
  users              User[]
  rolePermissions    RolePermission[]
  commissionSettings CommissionSetting[]
  createdByRoot      Root?               @relation("RoleCreatedByRoot", fields: [createdById], references: [id], map: "roles_created_by_root_fk")
  createdByUser      User?               @relation("RoleCreatedByUser", fields: [createdById], references: [id], map: "roles_created_by_user_fk")

  @@index([createdById, createdByType])
  @@map("roles")
}

// Department for Employees (Can be created by both Root AND Admin)
model Department {
  id            String      @id @default(uuid())
  name          String      @unique
  description   String?     @db.LongText
  createdByType CreatorType @map("created_by_type")
  createdById   String      @map("created_by_id")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @default(now()) @updatedAt @map("updated_at")

  // Relations
  employees             Employee[]
  departmentPermissions DepartmentPermission[]
  createdByRoot         Root?                  @relation(fields: [createdById], references: [id], map: "departments_created_by_root_fk")
  createdByUser         User?                  @relation(fields: [createdById], references: [id], map: "departments_created_by_user_fk")

  @@index([createdById, createdByType])
  @@map("departments")
}

// ==================== PERMISSION MODELS (Can be created by both Root AND Admin) ====================
model RolePermission {
  id               String   @id @default(uuid())
  roleId           String   @map("role_id")
  serviceId        String   @map("service_id")
  canView          Boolean  @default(false) @map("can_view")
  canEdit          Boolean  @default(false) @map("can_edit")
  canSetCommission Boolean  @default(false) @map("can_set_commission")
  canProcess       Boolean  @default(false) @map("can_process")
  limits           Json?
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")

  // Can be created by Root OR Admin User
  createdByType CreatorType @map("created_by_type")
  createdById   String      @map("created_by_id")

  // Relations
  role          Role            @relation(fields: [roleId], references: [id])
  service       ServiceProvider @relation(fields: [serviceId], references: [id])
  createdByRoot Root?           @relation("RolePermissionCreatedByRoot", fields: [createdById], references: [id], map: "role_permissions_created_by_root_fk")
  createdByUser User?           @relation("RolePermissionCreatedByUser", fields: [createdById], references: [id], map: "role_permissions_created_by_user_fk")

  @@unique([roleId, serviceId])
  @@index([createdById, createdByType])
  @@map("role_permissions")
}

model UserPermission {
  id               String   @id @default(uuid())
  serviceId        String   @map("service_id")
  userId           String   @map("user_id")
  canView          Boolean  @default(false) @map("can_view")
  canEdit          Boolean  @default(false) @map("can_edit")
  canSetCommission Boolean  @default(false) @map("can_set_commission")
  canProcess       Boolean  @default(false) @map("can_process")
  limits           Json?
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")

  // Can be created by Root OR Admin User
  createdByType CreatorType @map("created_by_type")
  createdById   String      @map("created_by_id")

  // Relations
  service       ServiceProvider @relation(fields: [serviceId], references: [id])
  user          User            @relation(fields: [userId], references: [id])
  createdByRoot Root?           @relation("UserPermissionCreatedByRoot", fields: [createdById], references: [id], map: "user_permissions_created_by_root_fk")
  createdByUser User?           @relation("UserPermissionCreatedByUser", fields: [createdById], references: [id], map: "user_permissions_created_by_user_fk")

  @@unique([userId, serviceId])
  @@index([createdById, createdByType])
  @@map("user_permissions")
}

model DepartmentPermission {
  id           String   @id @default(uuid())
  departmentId String   @map("department_id")
  permission   String
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  // Can be created by Root OR Admin User
  createdByType CreatorType @map("created_by_type")
  createdById   String      @map("created_by_id")

  // Relations
  department    Department @relation(fields: [departmentId], references: [id])
  createdByRoot Root?      @relation("DepartmentPermissionCreatedByRoot", fields: [createdById], references: [id], map: "department_permissions_created_by_root_fk")
  createdByUser User?      @relation("DepartmentPermissionCreatedByUser", fields: [createdById], references: [id], map: "department_permissions_created_by_user_fk")

  @@unique([departmentId, permission])
  @@index([createdById, createdByType])
  @@map("department_permissions")
}

model EmployeePermission {
  id         String    @id @default(uuid())
  employeeId String    @map("employee_id")
  permission String
  assignedAt DateTime  @default(now()) @map("assigned_at")
  revokedAt  DateTime? @map("revoked_at")
  isActive   Boolean   @default(true) @map("is_active")

  // Can be created by Root OR Admin User
  createdByType CreatorType @map("created_by_type")
  createdById   String      @map("created_by_id")

  // Relations
  employee      Employee @relation(fields: [employeeId], references: [id])
  createdByRoot Root?    @relation("EmployeePermissionCreatedByRoot", fields: [createdById], references: [id], map: "employee_permissions_created_by_root_fk")
  createdByUser User?    @relation("EmployeePermissionCreatedByUser", fields: [createdById], references: [id], map: "employee_permissions_created_by_user_fk")

  @@unique([employeeId, permission])
  @@index([createdById, createdByType])
  @@map("employee_permissions")
}

// ==================== SERVICE & PERMISSION SYSTEM ====================

model ServiceProvider {
  id                   String   @id @default(uuid())
  name                 String
  code                 String   @unique
  isActive             Boolean  @default(false)
  iconUrl              String?  @map("icon_url")
  description          String?  @db.LongText
  envConfig            Json?    @map("env_config")
  apiIntegrationStatus Boolean? @default(false) @map("api_integration_status")
  parentId             String?  @map("parent_id")
  hierarchyLevel       String   @map("hierarchy_level")
  hierarchyPath        String   @map("hierarchy_path") @db.Text

  // Service can only be created by Root
  createdByRootId String @map("created_by_root_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  parent             ServiceProvider?    @relation("ServiceProviderHierarchy", fields: [parentId], references: [id])
  subServices        ServiceProvider[]   @relation("ServiceProviderHierarchy")
  apiEntities        ApiEntity[]
  transactions       Transaction[]
  rolePermissions    RolePermission[]
  userPermissions    UserPermission[]
  commissionSettings CommissionSetting[]
  ledgerEntries      LedgerEntry[]
  createdByRoot      Root                @relation(fields: [createdByRootId], references: [id])

  @@index([parentId])
  @@index([createdByRootId])
  @@map("service_providers")
}

// ==================== KYC & ADDRESS SYSTEM ====================

// User KYC (For individual verification - Used by ALL users)
model UserKyc {
  id                 String    @id @default(uuid())
  userId             String    @unique @map("user_id") // Added @unique for one-to-one relation
  firstName          String    @map("first_name")
  lastName           String    @map("last_name")
  fatherName         String    @map("father_name")
  dob                DateTime
  gender             Gender
  status             KycStatus @default(PENDING)
  type               KycTypes  @default(USER_KYC)
  kycRejectionReason String?   @map("kyc_rejection_reason") @db.LongText
  addressId          String    @map("address_id")
  panFile            String    @map("pan_file")
  aadhaarFile        String    @map("aadhaar_file")
  addressProofFile   String    @map("address_proof_file")
  photo              String
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @default(now()) @updatedAt @map("updated_at")
  deletedAt          DateTime? @map("deleted_at")

  // Relations
  user        User         @relation(fields: [userId], references: [id])
  address     Address      @relation(fields: [addressId], references: [id])
  piiConsents PiiConsent[]

  // KYC can be verified by Root OR Admin
  verifiedByType CreatorType? @map("verified_by_type")
  verifiedById   String?      @map("verified_by_id")
  verifiedAt     DateTime?    @map("verified_at")

  // Relations for verifier - Fixed with unique relation names and map
  verifiedByRoot Root? @relation("UserKycVerifiedByRoot", fields: [verifiedById], references: [id], map: "user_kyc_verified_by_root_fk")
  verifiedByUser User? @relation("UserKycVerifiedByUser", fields: [verifiedById], references: [id], map: "user_kyc_verified_by_user_fk")

  @@index([userId])
  @@index([status])
  @@index([verifiedById, verifiedByType])
  @@map("user_kyc")
}

// Business KYC (Only for Admin users who want business accounts)
model BusinessKyc {
  id              String       @id @default(uuid())
  userId          String       @map("user_id")
  user            User         @relation(fields: [userId], references: [id])
  businessName    String       @map("business_name") @db.Text
  businessType    BusinessType @map("business_type")
  status          KycStatus    @default(PENDING)
  rejectionReason String?      @map("rejection_reason") @db.LongText

  addressId String  @map("address_id")
  address   Address @relation(fields: [addressId], references: [id])

  panFile String @map("pan_file")
  gstFile String @map("gst_file")

  // --------- Proprietorship Specific ---------
  udhyamAadhar String? @map("udhyam_aadhar")
  brDoc        String? @map("br_doc")

  // --------- Partnership Specific ---------
  partnershipDeed   String? @map("partnership_deed")
  partnerKycNumbers Int?    @map("partner_kyc_numbers")

  // --------- Private Limited Specific ---------
  cin                  String? @map("cin")
  moaFile              String? @map("moa_file")
  aoaFile              String? @map("aoa_file")
  directorKycNumbers   Int?    @default(2) @map("director_kyc_numbers")
  directorShareholding String? @map("director_shareholding_file")

  piiConsents PiiConsent[]

  // Business KYC can ONLY be verified by Root
  verifiedByRootId String?   @map("verified_by_root_id")
  verifiedByRoot   Root?     @relation("BusinessKycVerifiedBy", fields: [verifiedByRootId], references: [id])
  verifiedAt       DateTime? @map("verified_at")

  // Root who owns/created this Business KYC record (different relation)
  rootId String? @map("root_id")
  root   Root?   @relation("BusinessKycOwnedBy", fields: [rootId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@unique([userId])
  @@index([userId, status])
  @@index([verifiedByRootId])
  @@index([rootId])
  @@map("business_kycs")
}

model State {
  id        String    @id @default(uuid())
  stateName String    @map("state_name")
  stateCode String    @unique @map("state_code")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at")
  Address   Address[]

  @@map("states")
}

model City {
  id        String    @id @default(uuid())
  cityName  String    @map("city_name")
  cityCode  String    @unique @map("city_code")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at")
  Address   Address[]

  @@map("cities")
}

model Address {
  id           String        @id @default(uuid())
  address      String        @db.LongText
  pinCode      String        @map("pin_code")
  stateId      String        @map("state_id")
  cityId       String        @map("city_id")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  city         City          @relation(fields: [cityId], references: [id])
  state        State         @relation(fields: [stateId], references: [id])
  UserKyc      UserKyc[]
  businessKycs BusinessKyc[]

  @@index([cityId])
  @@index([stateId])
  @@map("addresses")
}

// ==================== API & WEBHOOK SYSTEM ====================

model ApiEntity {
  id               String       @id @default(uuid())
  entityType       String       @map("entity_type")
  entityId         String       @unique @map("entity_id")
  reference        String?      @unique
  userId           String       @map("user_id")
  serviceId        String?      @map("service_id")
  status           EntityStatus @default(PENDING)
  isActive         Boolean      @default(true) @map("is_active")
  provider         ApiProvider
  providerData     Json?        @map("provider_data")
  metadata         Json?
  verificationData Json?        @map("verification_data")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  verifiedAt       DateTime?    @map("verified_at")

  // Relations
  user         User             @relation(fields: [userId], references: [id])
  service      ServiceProvider? @relation(fields: [serviceId], references: [id])
  apiWebhooks  ApiWebhook[]
  transactions Transaction[]

  @@index([userId, serviceId])
  @@index([entityType, entityId])
  @@index([status, createdAt])
  @@map("api_entities")
}

model ApiWebhook {
  id            String       @id @default(uuid())
  transactionId String?      @map("transaction_id")
  apiEntityId   String?      @map("api_entity_id")
  provider      ApiProvider
  eventType     String       @map("event_type")
  payload       Json
  signature     String?
  headers       Json?
  status        String       @default("PENDING")
  attempts      Int          @default(0)
  lastAttemptAt DateTime?    @map("last_attempt_at")
  response      Json?
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  apiEntity     ApiEntity?   @relation(fields: [apiEntityId], references: [id])
  transaction   Transaction? @relation(fields: [transactionId], references: [id])

  @@index([transactionId])
  @@index([apiEntityId])
  @@index([provider, eventType])
  @@map("api_webhooks")
}

// ==================== SECURITY & SETTINGS ====================

model IpWhitelist {
  id         String   @id @default(uuid())
  domainName String   @unique @map("domain_name")
  serverIp   String   @map("server_ip")
  localIp    String?  @unique @map("local_ip")
  userId     String   @map("user_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  user   User    @relation(fields: [userId], references: [id])
  root   Root?   @relation(fields: [rootId], references: [id])
  rootId String?

  @@map("ip_whitelists")
}

model SystemSetting {
  id             String   @id @default(uuid())
  companyName    String   @map("company_name")
  companyLogo    String   @map("company_logo")
  favIcon        String   @map("fav_icon")
  phoneNumber    String   @map("phone_number")
  whatsappNumber String   @map("whatsapp_number")
  companyEmail   String   @map("company_email")
  facebookUrl    String   @map("facebook_url")
  instagramUrl   String   @map("instagram_url")
  twitterUrl     String   @map("twitter_url")
  linkedinUrl    String   @map("linkedin_url")
  websiteUrl     String   @map("website_url")
  settings       Json?
  rootId         String   @map("root_id")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  root Root @relation(fields: [rootId], references: [id])

  @@index([rootId])
  @@map("system_settings")
}

model PiiConsent {
  id            String       @id @default(uuid())
  userId        String       @map("user_id")
  userKycId     String?      @map("user_kyc_id")
  piiType       String
  piiHash       String
  providedAt    DateTime     @default(now())
  expiresAt     DateTime
  scope         String
  createdAt     DateTime     @default(now())
  user          User         @relation(fields: [userId], references: [id])
  userKyc       UserKyc?     @relation(fields: [userKycId], references: [id])
  businessKyc   BusinessKyc? @relation(fields: [businessKycId], references: [id])
  businessKycId String?

  @@unique([userId, piiType, scope])
  @@index([userKycId])
  @@map("pii_consents")
}

model Refund {
  id            String      @id @default(uuid())
  transactionId String      @map("transaction_id")
  initiatedBy   String      @map("initiated_by")
  amount        BigInt
  status        TxStatus    @default(PENDING)
  reason        String?
  metadata      Json?
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  transaction   Transaction @relation(fields: [transactionId], references: [id])

  @@index([transactionId])
  @@map("refunds")
}

model IdempotencyKey {
  key       String   @id
  userId    String?  @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expired_at")
  used      Boolean  @default(false)
  meta      Json?

  @@map("idempotency_keys")
}

// ==================== ENUMS ====================

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum UserHierarchyLevel {
  ADMIN
  STATE
  HEAD
  MASTER_DISTRIBUTOR
  DISTRIBUTOR
  RETAILER
}

enum CreatorType {
  ROOT
  ADMIN
}

enum AccountType {
  PERSONAL
  BUSINESS
}

enum CommissionType {
  FLAT
  PERCENTAGE
}

enum TxStatus {
  PENDING
  SUCCESS
  FAILED
  REVERSED
  REFUNDED
  CANCELLED
}

enum CommissionScope {
  ROLE
  USER
}

enum LedgerEntryType {
  DEBIT
  CREDIT
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum KycStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum KycTypes {
  AEPS
  USER_KYC
}

enum Currency {
  INR
}

enum ReferenceType {
  TRANSACTION
  COMMISSION
  REFUND
  ADJUSTMENT
  BONUS
  CHARGE
  FEE
  TAX
  PAYOUT
  COLLECTION
}

enum EntityStatus {
  ACTIVE
  INACTIVE
  PENDING
  REJECTED
  SUSPENDED
}

enum PaymentType {
  COLLECTION
  PAYOUT
  REFUND
  REVERSAL
  COMMISSION
  FEE
  TAX
  ADJUSTMENT
  CHARGE
  FUND_REQ_BANK
  FUND_REQ_RAZORPAY
}

enum WalletType {
  PRIMARY
  COMMISSION
  ESCROW
  TAX
  BONUS
  HOLDING
}

enum ApiProvider {
  BULKPE
  PAYTM
  RAZORPAY
  CCAVENUE
  BILLDESK
  AIRTEL
  JIO
  OTHER
}

enum BusinessType {
  PROPRIETORSHIP
  PARTNERSHIP
  PRIVATE_LIMITED
}
